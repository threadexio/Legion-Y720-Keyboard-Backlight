BANNER = \n\033[38;5;196m██\033[38;5;242m╗\033[0m     \033[38;5;196m███████\033[38;5;242m╗\033[0m \033[38;5;196m██████\033[38;5;242m╗\033[0m \033[38;5;196m██\033[38;5;242m╗\033[0m \033[38;5;196m██████\033[38;5;242m╗\033[0m \033[38;5;196m███\033[38;5;242m╗\033[0m   \033[38;5;196m██\033[38;5;242m╗\n\033[38;5;160m██\033[38;5;241m║\033[0m     \033[38;5;160m██\033[38;5;241m╔════╝\033[38;5;160m██\033[38;5;241m╔════╝\033[0m \033[38;5;160m██\033[38;5;241m║\033[38;5;160m██\033[38;5;241m╔═══\033[38;5;160m██\033[38;5;241m╗\033[38;5;160m████\033[38;5;241m╗\033[0m  \033[38;5;160m██\033[38;5;241m║\n\033[38;5;124m██\033[38;5;240m║\033[0m     \033[38;5;124m█████\033[38;5;240m╗\033[0m  \033[38;5;124m██\033[38;5;240m║\033[0m  \033[38;5;124m███\033[38;5;240m╗\033[38;5;124m██\033[38;5;240m║\033[38;5;124m██\033[38;5;240m║\033[0m   \033[38;5;124m██\033[38;5;240m║\033[38;5;124m██\033[38;5;240m╔\033[38;5;124m██\033[38;5;240m╗\033[0m \033[38;5;124m██\033[38;5;240m║\n\033[38;5;88m██\033[38;5;239m║\033[0m     \033[38;5;88m██\033[38;5;239m╔══╝\033[0m  \033[38;5;88m██\033[38;5;239m║\033[0m   \033[38;5;88m██\033[38;5;239m║\033[38;5;88m██\033[38;5;239m║\033[38;5;88m██\033[38;5;239m║\033[0m   \033[38;5;88m██\033[38;5;239m║\033[38;5;88m██\033[38;5;239m║╚\033[38;5;88m██\033[38;5;239m╗\033[38;5;88m██\033[38;5;239m║\n\033[38;5;52m███████\033[38;5;238m╗\033[38;5;52m███████\033[38;5;238m╗╚\033[38;5;52m██████\033[38;5;238m╔╝\033[38;5;52m██\033[38;5;238m║╚\033[38;5;52m██████\033[38;5;238m╔╝\033[38;5;52m██\033[38;5;238m║\033[0m \033[38;5;238m╚\033[38;5;52m████\033[38;5;238m║\n\033[38;5;237m╚══════╝╚══════╝\033[0m \033[38;5;237m╚═════╝\033[0m \033[38;5;237m╚═╝\033[0m \033[38;5;237m╚═════╝\033[0m \033[38;5;237m╚═╝\033[0m  \033[38;5;237m╚═══╝\n                                               \033[38;5;236m\n\033[38;5;196m██\033[38;5;242m╗\033[0m   \033[38;5;196m██\033[38;5;242m╗\033[38;5;196m███████\033[38;5;242m╗\033[38;5;196m██████\033[38;5;242m╗\033[0m  \033[38;5;196m██████\033[38;5;242m╗\033[0m     \033[38;5;196m██\033[38;5;242m╗\033[0m  \033[38;5;196m██\033[38;5;242m╗\033[38;5;196m██████\033[38;5;242m╗\033[0m \033[38;5;196m██████\033[38;5;242m╗\033[0m \033[38;5;242m\n\033[38;5;241m╚\033[38;5;160m██\033[38;5;241m╗\033[0m \033[38;5;160m██\033[38;5;241m╔╝╚════\033[38;5;160m██\033[38;5;241m║╚════\033[38;5;160m██\033[38;5;241m╗\033[38;5;160m██\033[38;5;241m╔═\033[38;5;160m████\033[38;5;241m╗\033[0m    \033[38;5;160m██\033[38;5;241m║\033[0m \033[38;5;160m██\033[38;5;241m╔╝\033[38;5;160m██\033[38;5;241m╔══\033[38;5;160m██\033[38;5;241m╗\033[38;5;160m██\033[38;5;241m╔══\033[38;5;160m██\033[38;5;241m╗\n \033[38;5;240m╚\033[38;5;124m████\033[38;5;240m╔╝\033[0m     \033[38;5;124m██\033[38;5;240m╔╝\033[0m \033[38;5;124m█████\033[38;5;240m╔╝\033[38;5;124m██\033[38;5;240m║\033[38;5;124m██\033[38;5;240m╔\033[38;5;124m██\033[38;5;240m║\033[0m    \033[38;5;124m█████\033[38;5;240m╔╝\033[0m \033[38;5;124m██████\033[38;5;240m╔╝\033[38;5;124m██\033[38;5;240m║\033[0m  \033[38;5;124m██\033[38;5;240m║\n  \033[38;5;239m╚\033[38;5;88m██\033[38;5;239m╔╝\033[0m     \033[38;5;88m██\033[38;5;239m╔╝\033[0m \033[38;5;88m██\033[38;5;239m╔═══╝\033[0m \033[38;5;88m████\033[38;5;239m╔╝\033[38;5;88m██\033[38;5;239m║\033[0m    \033[38;5;88m██\033[38;5;239m╔═\033[38;5;88m██\033[38;5;239m╗\033[0m \033[38;5;88m██\033[38;5;239m╔══\033[38;5;88m██\033[38;5;239m╗\033[38;5;88m██\033[38;5;239m║\033[0m  \033[38;5;88m██\033[38;5;239m║\n   \033[38;5;52m██\033[38;5;238m║\033[0m      \033[38;5;52m██\033[38;5;238m║\033[0m  \033[38;5;52m███████\033[38;5;238m╗╚\033[38;5;52m██████\033[38;5;238m╔╝\033[0m    \033[38;5;52m██\033[38;5;238m║\033[0m  \033[38;5;52m██\033[38;5;238m╗\033[38;5;52m██████\033[38;5;238m╔╝\033[38;5;52m██████\033[38;5;238m╔╝\n   \033[38;5;237m╚═╝\033[0m      \033[38;5;237m╚═╝\033[0m  \033[38;5;237m╚══════╝\033[0m \033[38;5;237m╚═════╝\033[0m     \033[38;5;237m╚═╝\033[0m  \033[38;5;237m╚═╝╚═════╝\033[0m \033[38;5;237m╚═════╝\033[0m \033[38;5;237m\n                                                              \033[38;5;236m\033[0m\n

# ----------------- #

NAME := kbd-backlight
PREFIX ?= /usr/local

SYSTEM_WIDE_CFG := /etc/$(NAME)

# ----------------- #

SRCDIR := src
INCLUDEDIR := .
BUILDDIR := build
TARGETDIR := $(BUILDDIR)/bin
OBJDIR := $(BUILDDIR)/obj

SRCEXT := c
OBJEXT := o

SRCS := $(shell find $(SRCDIR) -type f -name *.$(SRCEXT))
OBJS := $(patsubst $(SRCDIR)/%.$(SRCEXT),$(OBJDIR)/%.$(OBJEXT),$(SRCS))

# ----------------- #

TOOLCHAIN_PREFIX ?=
CC ?= gcc

C ?= $(TOOLCHAIN_PREFIX)$(CC)

# Flags
RFLAGS ?= -std=c18 -pipe
WFLAGS ?= -Wall -Wextra
OFLAGS ?= -O2

LIBS := -lconfig

INCLUDES := -I$(INCLUDEDIR) -I$(SRCDIR)

CFLAGS := $(RFLAGS) $(WFLAGS) $(OFLAGS)
LFLAGS ?= $(LIBS) -D_FORTIFY_SOURCE=2 -fstack-clash-protection -fstack-protector

ifeq ($(STATIC),y)
	override CFLAGS += -static -static-libgcc
endif

# ----------------- #

all: banner info setup build

banner:
	@printf "$(BANNER)\n"

info:
	@printf "          CC │ $(C)\n" 
	@printf "   TOOLCHAIN │ $(TOOLCHAIN_PREFIX)\n"
	@printf "      RFLAGS │ $(RFLAGS)\n"
	@printf "      WFLAGS │ $(WFLAGS)\n"
	@printf "      OFLAGS │ $(OFLAGS)\n"
	@printf "        LIBS │ $(LIBS)\n"
	@printf "      LFLAGS │ $(LFLAGS)\n"
	@printf "      CFLAGS │ $(CFLAGS)\n"

help: banner
	@printf "Usage: make {variables} [recipe]\n"
	@printf "\n"
	@printf "Recipes:\n"
	@printf "  all         │ Build\n"
	@printf "  clean       │ Remove built object files\n"
	@printf "  distclean   │ Remove built object files & binaries\n"
	@printf "  install     │ Install the binary into \$$DESTDIR/\$$PREFIX\n"
	@printf "  uninstall   │ Uninstall from \$$DESTDIR/\$$PREFIX\n"
	@printf "  postinstall │ Post-installation stuff\n"

setup:
	@mkdir -p $(TARGETDIR)
	@mkdir -p $(OBJDIR)

build: $(OBJS)
	@printf " -> $(TARGETDIR)/$(NAME)\n"
	@$(C) $(LFLAGS) -o $(TARGETDIR)/$(NAME) $^

$(OBJDIR)/%.$(OBJEXT): $(SRCDIR)/%.$(SRCEXT)
	@printf " -> $@\n"
	@mkdir -p $(shell dirname $(@))
	@$(C) $(CFLAGS) $(INCLUDES) -c -o $@ $<

clean:
	@printf "Removing: built object files...\n"
	@rm -rf $(OBJDIR)

distclean: clean
	@printf "Removing: built binaries...\n"
	@rm -rf $(TARGETDIR)

install: all
	@printf "Installing binary to: $(DESTDIR)$(PREFIX)/bin/$(NAME)\n"
	@install -Dm0755 $(TARGETDIR)/$(NAME) $(DESTDIR)$(PREFIX)/bin/$(NAME)
	
	@printf "Installing config to: $(DESTDIR)$(SYSTEM_WIDE_CFG)/backlight.conf\n"
	@install -Dm0644 files/backlight.conf $(DESTDIR)$(SYSTEM_WIDE_CFG)/backlight.conf
	
	@printf "Installing default config to: $(DESTDIR)$(PREFIX)/share/$(NAME)/backlight.conf.default\n"
	@install -Dm0644 files/backlight.conf $(DESTDIR)$(PREFIX)/share/$(NAME)/backlight.conf.default
		
uninstall:
	@printf "Removing: $(DESTDIR)$(PREFIX)/bin/$(NAME)\n"
	@rm -rf $(DESTDIR)$(PREFIX)/bin/$(NAME)

	@printf "Removing: $(DESTDIR)$(SYSTEM_WIDE_CFG)\n"
	@rm -rf $(DESTDIR)$(SYSTEM_WIDE_CFG)
	
	@printf "Removing: $(DESTDIR)$(PREFIX)/share/$(NAME)\n"
	@rm -rf $(DESTDIR)$(PREFIX)/share/$(NAME)

	@-rm -rf $(DESTDIR)/etc/apparmor.d/kbd-backlight

postinstall: install
	@printf "Adding capability: cap_dac_override\n"
	@setcap cap_dac_override+eip $(DESTDIR)$(PREFIX)/bin/kbd-backlight

	@printf "Adding group: $(NAME)\n"
	@-groupadd -r "$(NAME)"

apparmor:
	@printf "Installing AppArmor profile...\n"
	@install -Dm644 files/apparmor.profile $(DESTDIR)/etc/apparmor.d/kbd-backlight

# Build the deb package
# make V="x.x.x" deb
deb:
	docker build -t kbd-backlight-deb packages/deb
	docker run --rm -it \
		-v $$PWD:/repo \
		-e v=$(V) \
		kbd-backlight-deb

# Build the rpm src and bin packages
# make V="x.x.x" rpm
# NOTE: We use --privileged because otherwise docker
#		wont let us do bind mounts inside the container
#		This is just so we dont cp the entire repo for no reason
rpm:
	docker build -t kbd-backlight-rpm packages/rpm
	docker run --rm -it \
		--privileged \
		-v $$PWD:/repo \
		-e v=$(V) \
		kbd-backlight-rpm
	
clean_docker:
	docker rmi kbd-backlight-deb kbd-backlight-rpm

.PHONY: all banner info help setup build clean distclean install uninstall postinstall apparmor deb rpm
